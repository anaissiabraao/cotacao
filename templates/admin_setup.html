<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurações do Sistema - PortoEx Admin</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='portoex-logo.png') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Segoe+UI:400,700,800&display=swap" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%); color:#2c3e50; font-family: 'Segoe UI', Arial, sans-serif; margin:0; padding:20px; }
        .container { max-width: 1200px; margin:0 auto; background:#fff; border-radius:15px; box-shadow:0 8px 32px rgba(0,0,0,0.1); overflow:hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; padding:30px; text-align:center; }
        .header h1 { margin:0; font-size:2.0rem; font-weight:800; }
        .content { padding: 24px; }
        .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:20px; }
        .card { background:#fff; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.08); padding:20px; }
        .card h3 { margin:0 0 12px 0; font-size:1.1rem; display:flex; gap:10px; align-items:center; color:#2c3e50; }
        .row { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid rgba(44,62,80,0.08); }
        .row:last-child { border-bottom:none; }
        .label { font-weight:600; color:#495057; }
        .value { font-family: 'Courier New', monospace; background: rgba(255,255,255,0.7); padding:4px 8px; border-radius:6px; }
        .form { display:flex; flex-direction:column; gap:12px; }
        .form .field { display:flex; align-items:center; justify-content:space-between; gap:12px; }
        .form input[type="text"], .form input[type="number"] { width:160px; padding:8px 10px; border:1px solid #ddd; border-radius:8px; }
        .switch { display:flex; align-items:center; gap:10px; }
        .actions { margin-top: 16px; display:flex; gap:10px; flex-wrap:wrap; }
        .btn { padding:10px 16px; border:none; border-radius:10px; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:8px; }
        .btn-primary { background:#667eea; color:#fff; }
        .btn-secondary { background:#6c757d; color:#fff; }
        .btn-warning { background:#ff9800; color:#fff; }
        .btn:hover { opacity: .95; transform: translateY(-1px); }
    </style>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div style="max-width:1200px;margin:12px auto;">
        {% for category, message in messages %}
          <div style="padding:10px 14px;border-radius:8px;margin-bottom:8px; color:#fff; background:{% if category=='success' %}#4caf50{% elif category=='warning' %}#ff9800{% else %}#f44336{% endif %};">
            {{ message }}
          </div>
        {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1><i class="fas fa-cogs"></i> Configurações do Sistema</h1>
      </div>
      <div class="content">
        <div class="grid">
          <div class="card">
            <h3><i class="fas fa-sliders-h"></i> Preferências</h3>
            <form class="form" method="POST" action="/admin/setup/salvar">
              <div class="field switch">
                <label class="label"><i class="fas fa-database"></i> Usar PostgreSQL</label>
                <input type="checkbox" name="use_db" {% if admin_config.use_db %}checked{% endif %} />
              </div>
              <div class="field">
                <label class="label">TTL Cache de Rotas (s)</label>
                <input type="number" name="cache_rotas_ttl" value="{{ admin_config.cache_rotas_ttl }}" min="0" />
              </div>
              <div class="field">
                <label class="label">TTL Cache da Base (s)</label>
                <input type="number" name="cache_base_ttl" value="{{ admin_config.cache_base_ttl }}" min="0" />
              </div>
              <div class="field switch">
                <label class="label"><i class="fas fa-bug"></i> Logs Verbosos</label>
                <input type="checkbox" name="verbose_logs" {% if admin_config.verbose_logs %}checked{% endif %} />
              </div>
              <div class="field">
                <label class="label">Melhor Envio - Client ID</label>
                <input type="text" name="melhor_envio_client_id" value="" placeholder="Opcional (usa env se vazio)" />
              </div>
              <div class="field">
                <label class="label">Melhor Envio - Client Secret</label>
                <input type="text" name="melhor_envio_client_secret" value="" placeholder="Opcional (usa env se vazio)" />
              </div>
              <div class="actions">
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar</button>
                <a href="/admin" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Voltar</a>
              </div>
            </form>
          </div>

          <div class="card">
            <h3><i class="fas fa-info-circle"></i> Status do Sistema</h3>
            <div class="row"><span class="label">Versão Python:</span><span class="value">{{ info_sistema.versao_python.split()[0] }}</span></div>
            <div class="row"><span class="label">Usuários Cadastrados:</span><span class="value">{{ info_sistema.usuarios_sistema }}</span></div>
            <div class="row"><span class="label">Logs em Memória:</span><span class="value">{{ info_sistema.logs_em_memoria }}</span></div>
            <div class="row"><span class="label">Histórico de Pesquisas:</span><span class="value">{{ info_sistema.historico_pesquisas }}</span></div>
            <div class="row"><span class="label">Total de Registros:</span><span class="value">{{ "{:,}".format(info_sistema.total_registros).replace(",",".") }}</span></div>
            <div class="row"><span class="label">Arquivo Excel:</span><span class="value">{{ info_sistema.arquivo_excel.split('/')[-1] if info_sistema.arquivo_excel else 'N/A' }}</span></div>
            <div class="row"><span class="label">Base Unificada (CSV):</span><span class="value">{{ info_sistema.base_unificada.split('/')[-1] if info_sistema.base_unificada else 'N/A' }}</span></div>
            <div class="actions">
              <form method="POST" action="/admin/setup/recarregar-base" style="display:inline-block">
                <button type="submit" class="btn btn-warning"><i class="fas fa-sync"></i> Recarregar Base</button>
              </form>
              <form method="POST" action="/admin/setup/testar-db" style="display:inline-block">
                <button type="submit" class="btn btn-primary"><i class="fas fa-database"></i> Testar DB</button>
              </form>
              <form method="POST" action="/admin/setup/testar-melhor-envio" style="display:inline-block">
                <button type="submit" class="btn btn-primary"><i class="fas fa-key"></i> Testar Melhor Envio</button>
              </form>
            </div>
          </div>

          {% if _ULTIMO_TESTE_DB %}
          <div class="card">
            <h3><i class="fas fa-stethoscope"></i> Último Teste de DB</h3>
            <div class="row"><span class="label">Data/Hora:</span><span class="value">{{ _ULTIMO_TESTE_DB.timestamp }}</span></div>
            <div class="row"><span class="label">Sucesso:</span><span class="value">{{ 'Sim' if _ULTIMO_TESTE_DB.ok else 'Não' }}</span></div>
            <div class="row"><span class="label">Registros:</span><span class="value">{{ _ULTIMO_TESTE_DB.rows }}</span></div>
            {% if not _ULTIMO_TESTE_DB.ok %}
              <div class="row"><span class="label">Erro:</span><span class="value">{{ _ULTIMO_TESTE_DB.error }}</span></div>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </body>
  </html>


