<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PortoEx - Gerenciar Calculadoras</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .admin-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .admin-header .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-title h1 {
            font-size: 1.8rem;
            margin: 0;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .nav-links a:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-links a.active {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .tabs-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .tabs-header {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            color: #2a5298;
            border-bottom-color: #2a5298;
            background: white;
        }

        .tab-button:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin: 0;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #2a5298;
            color: white;
        }

        .btn-primary:hover {
            background: #1e3c72;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-sm {
            padding: 5px 12px;
            font-size: 0.8rem;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .card-body {
            color: #6c757d;
        }

        .card-footer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .table tbody tr:hover {
            background: #f8f9fa;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3rem;
            color: #2c3e50;
            margin: 0;
        }

        .close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .form-control:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 2px rgba(42, 82, 152, 0.1);
        }

        .form-check {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .form-check input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #dee2e6;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #495057;
        }

        .formula-preview {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.9rem;
            color: #495057;
            margin-top: 10px;
        }

        .variable-help {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }

        .variable-help h5 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .variable-help code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            .tabs-header {
                flex-direction: column;
            }

            .card-grid {
                grid-template-columns: 1fr;
            }

            .section-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .table-container {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <div class="container">
            <div class="admin-title">
                <i class="fas fa-calculator"></i>
                <h1>Gerenciar Calculadoras</h1>
            </div>
            <div class="nav-links">
                <a href="/admin"><i class="fas fa-home"></i> Painel Principal</a>
                <a href="/admin/agentes"><i class="fas fa-users"></i> Agentes</a>
                <a href="/admin/calculadoras" class="active"><i class="fas fa-calculator"></i> Calculadoras</a>
                <a href="/admin/historico"><i class="fas fa-history"></i> Histórico</a>
            </div>
        </div>
    </header>

    <div class="main-container">
        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-button active" onclick="switchTab('tipos')">
                    <i class="fas fa-tags"></i> Tipos de Cálculo
                </button>
                <button class="tab-button" onclick="switchTab('formulas')">
                    <i class="fas fa-function"></i> Fórmulas
                </button>
                <button class="tab-button" onclick="switchTab('configuracoes')">
                    <i class="fas fa-cog"></i> Configurações de Agente
                </button>
            </div>

            <!-- Tab: Tipos de Cálculo -->
            <div id="tipos" class="tab-content active">
                <div class="section-header">
                    <h2 class="section-title">Tipos de Cálculo</h2>
                    <button class="btn btn-primary" onclick="showModal('modalTipo')">
                        <i class="fas fa-plus"></i> Novo Tipo
                    </button>
                </div>

                <div class="card-grid" id="tiposGrid">
                    <!-- Tipos serão carregados aqui via JavaScript -->
                </div>
            </div>

            <!-- Tab: Fórmulas -->
            <div id="formulas" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Fórmulas de Cálculo</h2>
                    <button class="btn btn-primary" onclick="showModal('modalFormula')">
                        <i class="fas fa-plus"></i> Nova Fórmula
                    </button>
                </div>

                <div class="table-container">
                    <table class="table" id="formulasTable">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Tipo</th>
                                <th>Fórmula</th>
                                <th>Prioridade</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Fórmulas serão carregadas aqui via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Configurações de Agente -->
            <div id="configuracoes" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Configurações por Agente</h2>
                    <button class="btn btn-primary" onclick="showModal('modalConfiguracao')">
                        <i class="fas fa-plus"></i> Nova Configuração
                    </button>
                </div>

                <div class="table-container">
                    <table class="table" id="configuracoesTable">
                        <thead>
                            <tr>
                                <th>Agente</th>
                                <th>Tipo de Cálculo</th>
                                <th>Status</th>
                                <th>Valores Customizados</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Configurações serão carregadas aqui via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Tipo de Cálculo -->
    <div id="modalTipo" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Tipo de Cálculo</h3>
                <button class="close" onclick="hideModal('modalTipo')">&times;</button>
            </div>
            <form id="formTipo">
                <input type="hidden" id="tipoId" name="id">
                <div class="form-group">
                    <label class="form-label">Nome *</label>
                    <input type="text" class="form-control" id="tipoNome" name="nome" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Descrição</label>
                    <textarea class="form-control" id="tipoDescricao" name="descricao" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Ordem de Exibição</label>
                    <input type="number" class="form-control" id="tipoOrdem" name="ordem_exibicao" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Configurações</label>
                    <div class="form-check">
                        <input type="checkbox" id="tipoUsaPesoCubado" name="usa_peso_cubado">
                        <label for="tipoUsaPesoCubado">Usar peso cubado</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" id="tipoUsaValorNF" name="usa_valor_nf">
                        <label for="tipoUsaValorNF">Usar valor da nota fiscal</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" id="tipoUsaDistancia" name="usa_distancia">
                        <label for="tipoUsaDistancia">Usar distância</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" id="tipoUsaPedagio" name="usa_pedagio">
                        <label for="tipoUsaPedagio">Usar pedágio</label>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-warning" onclick="hideModal('modalTipo')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Fórmula -->
    <div id="modalFormula" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Fórmula de Cálculo</h3>
                <button class="close" onclick="hideModal('modalFormula')">&times;</button>
            </div>
            <form id="formFormula">
                <input type="hidden" id="formulaId" name="id">
                <div class="form-group">
                    <label class="form-label">Nome *</label>
                    <input type="text" class="form-control" id="formulaNome" name="nome" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de Cálculo *</label>
                    <select class="form-control" id="formulaTipo" name="tipo_calculo_id" required>
                        <option value="">Selecione um tipo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Fórmula Matemática *</label>
                    <textarea class="form-control" id="formulaTexto" name="formula" rows="3" required 
                              placeholder="Ex: (peso_usado * valor_kg) + (distancia * 0.15) + pedagio"></textarea>
                    <div class="formula-preview" id="formulaPreview"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Prioridade</label>
                    <input type="number" class="form-control" id="formulaPrioridade" name="prioridade" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Valores Padrão (JSON)</label>
                    <textarea class="form-control" id="formulaValoresPadrao" name="valores_padrao" rows="3"
                              placeholder='{"valor_kg": 2.5, "taxa_distancia": 0.15}'></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Condições (JSON)</label>
                    <textarea class="form-control" id="formulaCondicoes" name="condicoes" rows="3"
                              placeholder='{"peso_usado": {"min": 0, "max": 100}}'></textarea>
                </div>
                
                <div class="variable-help">
                    <h5>Variáveis Disponíveis</h5>
                    <p><code>peso_usado</code> - Peso utilizado no cálculo (real ou cubado)</p>
                    <p><code>peso_real</code> - Peso real da carga</p>
                    <p><code>peso_cubado</code> - Peso cubado da carga</p>
                    <p><code>distancia</code> - Distância em km</p>
                    <p><code>pedagio</code> - Valor do pedágio</p>
                    <p><code>valor_nf</code> - Valor da nota fiscal</p>
                    <p><code>cubagem_m3</code> - Volume em m³</p>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-warning" onclick="hideModal('modalFormula')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Configuração de Agente -->
    <div id="modalConfiguracao" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Configuração de Agente</h3>
                <button class="close" onclick="hideModal('modalConfiguracao')">&times;</button>
            </div>
            <form id="formConfiguracao">
                <input type="hidden" id="configuracaoId" name="id">
                <div class="form-group">
                    <label class="form-label">Agente *</label>
                    <select class="form-control" id="configuracaoAgente" name="agente_id" required>
                        <option value="">Selecione um agente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de Cálculo *</label>
                    <select class="form-control" id="configuracaoTipo" name="tipo_calculo_id" required>
                        <option value="">Selecione um tipo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Valores Customizados (JSON)</label>
                    <textarea class="form-control" id="configuracaoValores" name="valores_customizados" rows="4"
                              placeholder='{"valor_kg": 3.0, "taxa_adicional": 0.05}'></textarea>
                </div>
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" id="configuracaoAtivo" name="ativo" checked>
                        <label for="configuracaoAtivo">Configuração ativa</label>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-warning" onclick="hideModal('modalConfiguracao')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Variáveis globais
        let currentTab = 'tipos';
        let tiposCalculoData = [];
        let formulasData = [];
        let configuracoesData = [];
        let agentesData = [];

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Formulários
            document.getElementById('formTipo').addEventListener('submit', handleSaveTipo);
            document.getElementById('formFormula').addEventListener('submit', handleSaveFormula);
            document.getElementById('formConfiguracao').addEventListener('submit', handleSaveConfiguracao);

            // Preview da fórmula
            document.getElementById('formulaTexto').addEventListener('input', updateFormulaPreview);
        }

        // Gerenciamento de Tabs
        function switchTab(tabName) {
            // Remover classe active de todos os botões e conteúdos
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Adicionar classe active ao botão e conteúdo selecionado
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');

            currentTab = tabName;
        }

        // Gerenciamento de Modais
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            // Limpar formulários
            const form = document.querySelector(`#${modalId} form`);
            if (form) form.reset();
        }

        // Carregar todos os dados
        async function loadAllData() {
            try {
                await Promise.all([
                    loadTiposCalculo(),
                    loadFormulas(),
                    loadConfiguracoes(),
                    loadAgentes()
                ]);
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showAlert('Erro ao carregar dados', 'danger');
            }
        }

        // Carregar tipos de cálculo
        async function loadTiposCalculo() {
            try {
                const response = await fetch('/api/admin/tipos-calculo');
                if (response.ok) {
                    tiposCalculoData = await response.json();
                    renderTiposCalculo();
                    updateTipoSelects();
                }
            } catch (error) {
                console.error('Erro ao carregar tipos de cálculo:', error);
            }
        }

        // Renderizar tipos de cálculo
        function renderTiposCalculo() {
            const grid = document.getElementById('tiposGrid');
            
            if (tiposCalculoData.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-tags"></i>
                        <h3>Nenhum tipo de cálculo</h3>
                        <p>Crie o primeiro tipo de cálculo para começar</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = tiposCalculoData.map(tipo => `
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">${tipo.nome}</h4>
                        <span class="badge ${tipo.ativo ? 'badge-success' : 'badge-danger'}">
                            ${tipo.ativo ? 'Ativo' : 'Inativo'}
                        </span>
                    </div>
                    <div class="card-body">
                        <p>${tipo.descricao || 'Sem descrição'}</p>
                        <div style="margin-top: 10px;">
                            ${tipo.usa_peso_cubado ? '<span class="badge badge-info">Peso Cubado</span>' : ''}
                            ${tipo.usa_valor_nf ? '<span class="badge badge-info">Valor NF</span>' : ''}
                            ${tipo.usa_distancia ? '<span class="badge badge-info">Distância</span>' : ''}
                            ${tipo.usa_pedagio ? '<span class="badge badge-info">Pedágio</span>' : ''}
                        </div>
                        <p><small>Ordem: ${tipo.ordem_exibicao} | ${tipo.total_formulas} fórmulas</small></p>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-sm btn-primary" onclick="editTipo(${tipo.id})">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTipo(${tipo.id})">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Carregar fórmulas
        async function loadFormulas() {
            try {
                const response = await fetch('/api/admin/formulas');
                if (response.ok) {
                    formulasData = await response.json();
                    renderFormulas();
                }
            } catch (error) {
                console.error('Erro ao carregar fórmulas:', error);
            }
        }

        // Renderizar fórmulas
        function renderFormulas() {
            const tbody = document.querySelector('#formulasTable tbody');
            
            if (formulasData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-function"></i>
                                <h4>Nenhuma fórmula cadastrada</h4>
                                <p>Crie a primeira fórmula de cálculo</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = formulasData.map(formula => `
                <tr>
                    <td>${formula.nome}</td>
                    <td>${formula.tipo_calculo_nome || '-'}</td>
                    <td><code>${formula.formula}</code></td>
                    <td>${formula.prioridade}</td>
                    <td>
                        <span class="badge ${formula.ativo ? 'badge-success' : 'badge-danger'}">
                            ${formula.ativo ? 'Ativo' : 'Inativo'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editFormula(${formula.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteFormula(${formula.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Carregar configurações
        async function loadConfiguracoes() {
            try {
                const response = await fetch('/api/admin/configuracoes-agente');
                if (response.ok) {
                    configuracoesData = await response.json();
                    renderConfiguracoes();
                }
            } catch (error) {
                console.error('Erro ao carregar configurações:', error);
            }
        }

        // Renderizar configurações
        function renderConfiguracoes() {
            const tbody = document.querySelector('#configuracoesTable tbody');
            
            if (configuracoesData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-cog"></i>
                                <h4>Nenhuma configuração</h4>
                                <p>Configure os agentes para usar os tipos de cálculo</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = configuracoesData.map(config => `
                <tr>
                    <td>${config.agente_nome || '-'}</td>
                    <td>${config.tipo_calculo_nome || '-'}</td>
                    <td>
                        <span class="badge ${config.ativo ? 'badge-success' : 'badge-danger'}">
                            ${config.ativo ? 'Ativo' : 'Inativo'}
                        </span>
                    </td>
                    <td>
                        ${Object.keys(config.valores_customizados).length > 0 ? 
                          '<span class="badge badge-info">Customizado</span>' : 
                          '<span class="badge badge-secondary">Padrão</span>'}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editConfiguracao(${config.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteConfiguracao(${config.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Carregar agentes
        async function loadAgentes() {
            try {
                const response = await fetch('/api/admin/agentes');
                if (response.ok) {
                    agentesData = await response.json();
                    updateAgenteSelects();
                }
            } catch (error) {
                console.error('Erro ao carregar agentes:', error);
            }
        }

        // Atualizar selects de tipos
        function updateTipoSelects() {
            const selects = ['formulaTipo', 'configuracaoTipo'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Selecione um tipo</option>' +
                        tiposCalculoData.map(tipo => 
                            `<option value="${tipo.id}">${tipo.nome}</option>`
                        ).join('');
                }
            });
        }

        // Atualizar selects de agentes
        function updateAgenteSelects() {
            const select = document.getElementById('configuracaoAgente');
            if (select) {
                select.innerHTML = '<option value="">Selecione um agente</option>' +
                    agentesData.map(agente => 
                        `<option value="${agente.id}">${agente.nome}</option>`
                    ).join('');
            }
        }

        // Preview da fórmula
        function updateFormulaPreview() {
            const formula = document.getElementById('formulaTexto').value;
            const preview = document.getElementById('formulaPreview');
            
            if (formula.trim()) {
                preview.textContent = `Preview: ${formula}`;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }

        // Handlers de salvamento
        async function handleSaveTipo(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Converter checkboxes
            data.usa_peso_cubado = document.getElementById('tipoUsaPesoCubado').checked;
            data.usa_valor_nf = document.getElementById('tipoUsaValorNF').checked;
            data.usa_distancia = document.getElementById('tipoUsaDistancia').checked;
            data.usa_pedagio = document.getElementById('tipoUsaPedagio').checked;

            try {
                const url = data.id ? `/api/admin/tipos-calculo/${data.id}` : '/api/admin/tipos-calculo';
                const method = data.id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    hideModal('modalTipo');
                    await loadTiposCalculo();
                    showAlert('Tipo de cálculo salvo com sucesso!', 'success');
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Erro ao salvar tipo de cálculo', 'danger');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao salvar tipo de cálculo', 'danger');
            }
        }

        async function handleSaveFormula(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            try {
                const url = data.id ? `/api/admin/formulas/${data.id}` : '/api/admin/formulas';
                const method = data.id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    hideModal('modalFormula');
                    await loadFormulas();
                    showAlert('Fórmula salva com sucesso!', 'success');
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Erro ao salvar fórmula', 'danger');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao salvar fórmula', 'danger');
            }
        }

        async function handleSaveConfiguracao(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            data.ativo = document.getElementById('configuracaoAtivo').checked;

            try {
                const url = data.id ? `/api/admin/configuracoes-agente/${data.id}` : '/api/admin/configuracoes-agente';
                const method = data.id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    hideModal('modalConfiguracao');
                    await loadConfiguracoes();
                    showAlert('Configuração salva com sucesso!', 'success');
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Erro ao salvar configuração', 'danger');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao salvar configuração', 'danger');
            }
        }

        // Funções de edição
        function editTipo(id) {
            const tipo = tiposCalculoData.find(t => t.id === id);
            if (tipo) {
                document.getElementById('tipoId').value = tipo.id;
                document.getElementById('tipoNome').value = tipo.nome;
                document.getElementById('tipoDescricao').value = tipo.descricao || '';
                document.getElementById('tipoOrdem').value = tipo.ordem_exibicao;
                document.getElementById('tipoUsaPesoCubado').checked = tipo.usa_peso_cubado;
                document.getElementById('tipoUsaValorNF').checked = tipo.usa_valor_nf;
                document.getElementById('tipoUsaDistancia').checked = tipo.usa_distancia;
                document.getElementById('tipoUsaPedagio').checked = tipo.usa_pedagio;
                showModal('modalTipo');
            }
        }

        function editFormula(id) {
            const formula = formulasData.find(f => f.id === id);
            if (formula) {
                document.getElementById('formulaId').value = formula.id;
                document.getElementById('formulaNome').value = formula.nome;
                document.getElementById('formulaTipo').value = formula.tipo_calculo_id;
                document.getElementById('formulaTexto').value = formula.formula;
                document.getElementById('formulaPrioridade').value = formula.prioridade;
                document.getElementById('formulaValoresPadrao').value = JSON.stringify(formula.valores_padrao, null, 2);
                document.getElementById('formulaCondicoes').value = JSON.stringify(formula.condicoes, null, 2);
                updateFormulaPreview();
                showModal('modalFormula');
            }
        }

        function editConfiguracao(id) {
            const config = configuracoesData.find(c => c.id === id);
            if (config) {
                document.getElementById('configuracaoId').value = config.id;
                document.getElementById('configuracaoAgente').value = config.agente_id;
                document.getElementById('configuracaoTipo').value = config.tipo_calculo_id;
                document.getElementById('configuracaoValores').value = JSON.stringify(config.valores_customizados, null, 2);
                document.getElementById('configuracaoAtivo').checked = config.ativo;
                showModal('modalConfiguracao');
            }
        }

        // Funções de exclusão
        async function deleteTipo(id) {
            if (confirm('Tem certeza que deseja excluir este tipo de cálculo?')) {
                try {
                    const response = await fetch(`/api/admin/tipos-calculo/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        await loadTiposCalculo();
                        showAlert('Tipo de cálculo excluído com sucesso!', 'success');
                    } else {
                        const error = await response.json();
                        showAlert(error.message || 'Erro ao excluir tipo de cálculo', 'danger');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    showAlert('Erro ao excluir tipo de cálculo', 'danger');
                }
            }
        }

        async function deleteFormula(id) {
            if (confirm('Tem certeza que deseja excluir esta fórmula?')) {
                try {
                    const response = await fetch(`/api/admin/formulas/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        await loadFormulas();
                        showAlert('Fórmula excluída com sucesso!', 'success');
                    } else {
                        const error = await response.json();
                        showAlert(error.message || 'Erro ao excluir fórmula', 'danger');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    showAlert('Erro ao excluir fórmula', 'danger');
                }
            }
        }

        async function deleteConfiguracao(id) {
            if (confirm('Tem certeza que deseja excluir esta configuração?')) {
                try {
                    const response = await fetch(`/api/admin/configuracoes-agente/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        await loadConfiguracoes();
                        showAlert('Configuração excluída com sucesso!', 'success');
                    } else {
                        const error = await response.json();
                        showAlert(error.message || 'Erro ao excluir configuração', 'danger');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    showAlert('Erro ao excluir configuração', 'danger');
                }
            }
        }

        // Mostrar alertas
        function showAlert(message, type) {
            // Remover alertas existentes
            document.querySelectorAll('.alert').forEach(alert => alert.remove());

            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;

            const container = document.querySelector('.main-container');
            container.insertBefore(alert, container.firstChild);

            // Remover após 5 segundos
            setTimeout(() => alert.remove(), 5000);
        }
    </script>
</body>
</html>
