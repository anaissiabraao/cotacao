HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>PortoEx - Cota√ß√£o Controladoria</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Frameworks e Libs -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      --primary: #1976d2;
      --accent: #e53935;
      --bg: #f7f9fa;
      --bg-dark: #181c23;
      --card: #fff;
      --card-dark: #23272f;
      --text: #23272f;
      --text-dark: #f7f9fa;
      --shadow: 0 2px 24px 0 rgba(25, 118, 210, 0.08);
      --radius: 18px;
      --transition: .18s cubic-bezier(.4,0,.2,1);
    }
    html, body {
      margin: 0; padding: 0;
      font-family: 'Inter', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      transition: background .2s, color .2s;
    }
    body.dark {
      background: var(--bg-dark);
      color: var(--text-dark);
    }
    .container {
      max-width: 1100px;
      margin: 32px auto;
      padding: 24px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: background .2s;
    }
    body.dark .container {
      background: var(--card-dark);
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
    }
    header h1 {
      font-size: 2.1rem;
      font-weight: 800;
      letter-spacing: -1.5px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .theme-btn {
      border: none;
      background: none;
      font-size: 1.5rem;
      color: var(--primary);
      cursor: pointer;
      transition: color .2s;
    }
    .theme-btn:hover { color: var(--accent); }
    .consulta-btn {
      text-decoration: none;
      color: var(--primary);
      font-weight: 600;
      font-size: 1.02rem;
      padding: 4px 12px;
      border-radius: 8px;
      background: rgba(25,118,210,0.08);
      transition: background .2s;
      margin-right: 8px;
    }
    .consulta-btn:hover { background: rgba(25,118,210,0.18);}
    .pbi-btn {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 18px;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 18px;
      cursor: pointer;
      transition: background .2s;
      box-shadow: 0 2px 8px 0 rgba(25, 118, 210, 0.09);
    }
    .pbi-btn:hover { background: var(--accent);}
    /* Tabs */
    .tabs {
      display: flex;
      margin-bottom: 24px;
      border-bottom: 2px solid #e3e8ee;
    }
    .tab-btn {
      flex: 1;
      background: none;
      border: none;
      padding: 14px 0;
      font-size: 1.1em;
      cursor: pointer;
      color: var(--text);
      font-weight: 600;
      border-bottom: 3px solid transparent;
      transition: color .2s, border-bottom .2s;
    }
    .tab-btn.active {
      color: var(--primary);
      border-bottom: 3px solid var(--primary);
      background: rgba(25,118,210,0.04);
    }
    body.dark .tab-btn { color: var(--text-dark);}
    body.dark .tab-btn.active { color: var(--accent); border-bottom: 3px solid var(--accent);}
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    /* Formul√°rios */
    .form-container {
      margin-bottom: 32px;
    }
    .row {
      display: flex;
      gap: 32px;
      flex-wrap: wrap;
    }
    .col { flex: 1; min-width: 270px; }
    .form-group { margin-bottom: 18px; }
    label { font-weight: 600; margin-bottom: 6px; display: block;}
    input, select, .select2-container--classic .select2-selection--single {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1.5px solid #d1d5db;
      font-size: 1rem;
      background: #f7f9fa;
      transition: border .2s;
      margin-top: 3px;
    }
    body.dark input, body.dark select, body.dark .select2-container--classic .select2-selection--single {
      background: #23272f;
      color: #f7f9fa;
      border-color: #3a3f4b;
    }
    .btn-calcular {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 22px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      margin-top: 12px;
      transition: background .2s;
      box-shadow: 0 2px 8px 0 rgba(229, 57, 53, 0.08);
    }
    .btn-calcular:hover { background: #b71c1c;}
    /* Resultados */
    #resultados, #fracionado-resultado {
      margin-top: 32px;
      animation: fadeIn .7s;
    }
    @keyframes fadeIn { from { opacity: 0;} to { opacity: 1; } }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 18px;
      background: #f7f9fa;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px 0 rgba(25, 118, 210, 0.06);
    }
    body.dark table { background: #23272f;}
    th, td {
      border: none;
      padding: 12px 10px;
      text-align: left;
      font-size: 1rem;
    }
    th {
      background: var(--primary);
      color: #fff;
      font-weight: 700;
      letter-spacing: .5px;
    }
    tr:nth-child(even) { background: #f1f5fa;}
    body.dark tr:nth-child(even) { background: #252a34;}
    .resultado-info p { margin: 8px 0; font-size: 1.08rem;}
    /* Mapa */
    #map { width: 100%; height: 320px; border-radius: 12px; margin-top: 22px; }
    /* Power BI Modal */
    .pbi-modal-bg {
      display: none; position: fixed; top:0; left:0; width:100vw; height:100vh;
      background: rgba(36,37,38,0.75); z-index: 9999; align-items: center; justify-content: center;
    }
    .pbi-modal-bg.active { display: flex;}
    .pbi-modal {
      background: #fff; padding: 0; border-radius: 18px; max-width: 900px; width: 98vw; box-shadow: var(--shadow);
      position: relative; animation: fadeIn .5s;
    }
    .pbi-modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 24px; background: var(--primary); color: #fff; border-radius: 18px 18px 0 0;
    }
    .pbi-modal-body { padding: 0 0 18px 0;}
    .pbi-modal iframe { width: 100%; height: 440px; border: none; border-radius: 0 0 18px 18px;}
    .close-btn {
      background: none; border: none; font-size: 1.3rem; color: #fff; cursor: pointer;
    }
    /* Loading */
    .loading { display: flex; align-items: center; gap: 18px; margin-top: 18px;}
    .spinner {
      width: 28px; height: 28px; border: 4px solid #e3e8ee; border-top: 4px solid var(--primary);
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Fracionado extra */
    #fracionado-form input, #fracionado-form select { width: 100%; padding: 8px; }
    #fracionado-resultado h3 { margin-top: 0; color: var(--primary);}
    /* Responsivo */
    @media (max-width: 800px) {
      .container { padding: 12px;}
      .row { flex-direction: column; gap: 0;}
      header { flex-direction: column; gap: 8px;}
      .pbi-modal { max-width: 98vw;}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fa-solid fa-truck-fast"></i> PortoEx - Cota√ß√£o Controladoria</h1>
      <button id="theme-toggle" class="theme-btn" title="Alternar tema">
        <i class="fa-solid fa-moon" id="theme-icon"></i>
      </button>
      <a href="https://onedrive.live.com/?id=7D2F1EE6EAD699A1%21s3c277927e98244b3a012f3122abe84a5&cid=7D2F1EE6EAD699A1&sb=name&sd=1" target="_blank" class="consulta-btn">
        <i class="fa-solid fa-table-list"></i> Consultar Tabela de Agentes
      </a>
    </header>
    <button class="pbi-btn" id="abrir-pbi">üìä Target BI</button>
    <!-- Abas -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="rota">C√°lculo de Rota</button>
      <button class="tab-btn" data-tab="fracionado">Fracionado</button>
    </div>
    <!-- C√°lculo de Rota -->
    <main class="form-container tab-content active" id="tab-rota">
      <div class="row">
        <div class="col">
          <div class="form-group">
            <label for="uf_origem">Estado de Origem</label>
            <select id="uf_origem" class="select2-enable" data-placeholder="Selecione o estado"></select>
          </div>
          <div class="form-group">
            <label for="municipio_origem">Munic√≠pio de Origem</label>
            <select id="municipio_origem" class="select2-enable" data-placeholder="Selecione o munic√≠pio" disabled></select>
          </div>
        </div>
        <div class="col">
          <div class="form-group">
            <label for="uf_destino">Estado de Destino</label>
            <select id="uf_destino" class="select2-enable" data-placeholder="Selecione o estado"></select>
          </div>
          <div class="form-group">
            <label for="municipio_destino">Munic√≠pio de Destino</label>
            <select id="municipio_destino" class="select2-enable" data-placeholder="Selecione o munic√≠pio" disabled></select>
          </div>
        </div>
      </div>
      <button id="btn_calcular" class="btn-calcular">
        <i class="fa-solid fa-calculator"></i> Calcular Custos
      </button>
      <div id="loading" class="loading" style="display:none;">
        <div class="spinner"></div>
        <p>Calculando rota e custos...</p>
      </div>
      <div id="resultados" style="display: none">
        <div id="map"></div>
        <table>
          <thead>
            <tr>
              <th>Tipo de Ve√≠culo</th>
              <th>Custo (R$)</th>
            </tr>
          </thead>
          <tbody id="tabela-resultado"></tbody>
        </table>
        <div class="resultado-info">
          <p><strong>Rota:</strong> <span id="res-origem"></span> ‚Üí <span id="res-destino"></span></p>
          <p><strong>Dist√¢ncia:</strong> <span id="res-distancia"></span> km</p>
          <p><strong>Tempo estimado:</strong> <span id="res-tempo"></span></p>
          <p><strong>Consumo estimado:</strong> <span id="res-consumo"></span> L</p>
          <p><strong>Emiss√£o de CO‚ÇÇ:</strong> <span id="res-co2"></span> kg</p>
          <p><strong>Ped√°gio estimado:</strong> R$ <span id="res-pedagio"></span></p>
        </div>
        <button id="btn_gerar_pdf" class="btn-calcular" style="background: #1976d2;">
          <i class="fa-solid fa-file-pdf"></i> Salvar Relat√≥rio em PDF
        </button>
      </div>
    </main>
    <!-- Fracionado -->
    <main class="form-container tab-content" id="tab-fracionado">
      <form id="fracionado-form" onsubmit="return false;">
        <div class="row">
          <div class="col">
            <div class="form-group">
              <label for="uf_origem_frac">Estado de Origem</label>
              <select id="uf_origem_frac" class="select2-enable"></select>
            </div>
            <div class="form-group">
              <label for="municipio_origem_frac">Munic√≠pio de Origem</label>
              <select id="municipio_origem_frac" class="select2-enable" disabled></select>
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label for="uf_destino_frac">Estado de Destino</label>
              <select id="uf_destino_frac" class="select2-enable"></select>
            </div>
            <div class="form-group">
              <label for="municipio_destino_frac">Munic√≠pio de Destino</label>
              <select id="municipio_destino_frac" class="select2-enable" disabled></select>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <div class="form-group">
              <label for="peso-frac">Peso (kg)</label>
              <input type="number" id="peso-frac" value="10" min="0.01" step="0.01" required>
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label for="cubagem-frac">Cubagem (m¬≥)</label>
              <input type="number" id="cubagem-frac" value="0.05" min="0" step="0.01" required>
            </div>
          </div>
        </div>
        <button id="btn-fracionado" class="btn-calcular">
          <i class="fa-solid fa-calculator"></i> Calcular Frete Fracionado
        </button>
      </form>
      <div id="fracionado-resultado">
        {% if resultado %}
          <h3>Resultado do Frete Fracionado</h3>
          <p><strong>Origem:</strong> {{ resultado.cidades_origem }} - {{ resultado.uf_origem }}</p>
          <p><strong>Destino:</strong> {{ resultado.cidades_destino }} - {{ resultado.uf_destino }}</p>
          <p><strong>Peso:</strong> {{ resultado.peso }} kg | <strong>Cubagem:</strong> {{ resultado.cubagem }} m¬≥</p>
          <table style="width:100%;margin-top:18px;">
            <thead>
              <tr>
                <th>Etapa</th>
                <th>Fornecedor</th>
                <th>Categoria</th>
                <th>Custo (R$)</th>
                <th>Prazo (dias)</th>
              </tr>
            </thead>
            <tbody>
              {% for etapa in resultado.etapas %}
              <tr>
                <td>{{ etapa.etapa }}</td>
                <td>{{ etapa.fornecedor }}</td>
                <td>{{ etapa.categoria }}</td>
                <td>R$ {{ '%.2f'|format(etapa.custo) }}</td>
                <td>{{ etapa.prazo }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <p style="margin-top:18px;"><strong>Custo Total:</strong> R$ {{ resultado.custo_total }}<br>
          <strong>Prazo Total:</strong> {{ resultado.prazo_total }} dias</p>
        {% endif %}
      </div>
    </main>
  </div>
  <!-- Power BI Modal -->
  <div class="pbi-modal-bg" id="pbi-modal-bg">
    <div class="pbi-modal">
      <div class="pbi-modal-header">
        <span>Dashboard</span>
        <button class="close-btn" id="fechar-pbi" title="Fechar">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="pbi-modal-body">
        <iframe src="https://app.powerbi.com/view?r=eyJrIjoiYWUzODBiYmUtMWI1OC00NGVjLWFjNDYtYzYyMDQ3MzQ0MTQ0IiwidCI6IjM4MjViNTlkLTY1ZGMtNDM1Zi04N2M4LTkyM2QzMzkxYzMyOCJ9" allowfullscreen="true"></iframe>
      </div>
    </div>
  </div>
  <script>
    // Abas
    $(".tab-btn").on("click", function() {
      $(".tab-btn").removeClass("active");
      $(this).addClass("active");
      $(".tab-content").removeClass("active");
      $("#tab-" + $(this).data("tab")).addClass("active");
    });
    // Tema claro/escuro
    function setTheme(mode) {
      if (mode === "dark") {
        document.body.classList.add("dark");
        document.getElementById("theme-icon").classList.replace("fa-moon", "fa-sun");
      } else {
        document.body.classList.remove("dark");
        document.getElementById("theme-icon").classList.replace("fa-sun", "fa-moon");
      }
      localStorage.setItem("theme", mode);
    }
    $(document).ready(function () {
      // Tema
      const savedTheme = localStorage.getItem("theme") || "light";
      setTheme(savedTheme);
      $("#theme-toggle").on("click", function () {
        const currentTheme = document.body.classList.contains("dark") ? "dark" : "light";
        setTheme(currentTheme === "dark" ? "light" : "dark");
      });
      // Power BI Modal
      $("#abrir-pbi").on("click", function () {
        $("#pbi-modal-bg").addClass("active");
      });
      $("#fechar-pbi, #pbi-modal-bg").on("click", function (e) {
        if (e.target === this) {
          $("#pbi-modal-bg").removeClass("active");
        }
      });
      // Select2 AJAX para estados e munic√≠pios (Rota)
      $("#uf_origem, #uf_destino").select2({
        placeholder: "Selecione o estado",
        allowClear: true,
        theme: "classic",
        ajax: {
          url: "/estados",
          dataType: "json",
          delay: 250,
          processResults: function (data) {
            return { results: data };
          },
          cache: true,
        },
      });
      $("#uf_origem").on("change", function () {
        var uf = $(this).val();
        $("#municipio_origem").val(null).trigger("change");
        $("#municipio_origem").prop("disabled", !uf);
        if (uf) {
          $("#municipio_origem").select2({
            placeholder: "Selecione o munic√≠pio",
            allowClear: true,
            theme: "classic",
            ajax: {
              url: "/municipios/" + uf,
              dataType: "json",
              delay: 250,
              processResults: function (data) {
                return { results: data };
              },
              cache: true,
            },
          });
        } else {
          $("#municipio_origem").select2("destroy");
        }
      });
      $("#uf_destino").on("change", function () {
        var uf = $(this).val();
        $("#municipio_destino").val(null).trigger("change");
        $("#municipio_destino").prop("disabled", !uf);
        if (uf) {
          $("#municipio_destino").select2({
            placeholder: "Selecione o munic√≠pio",
            allowClear: true,
            theme: "classic",
            ajax: {
              url: "/municipios/" + uf,
              dataType: "json",
              delay: 250,
              processResults: function (data) {
                return { results: data };
              },
              cache: true,
            },
          });
        } else {
          $("#municipio_destino").select2("destroy");
        }
      });
      // Bot√£o calcular rota
      $("#btn_calcular").on("click", function () {
        const ufOrigem = $("#uf_origem").val();
        const munOrigem = $("#municipio_origem").val();
        const ufDestino = $("#uf_destino").val();
        const munDestino = $("#municipio_destino").val();
        if (!ufOrigem || !munOrigem || !ufDestino || !munDestino) {
          alert("Por favor, selecione origem e destino completos.");
          return;
        }
        $("#loading").show();
        $("#resultados").hide();
        $.ajax({
          url: "/calcular",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({
            uf_origem: ufOrigem,
            municipio_origem: munOrigem,
            uf_destino: ufDestino,
            municipio_destino: munDestino,
          }),
          success: function (resp) {
            $("#loading").hide();
            $("#res-origem").text(resp.analise.origem);
            $("#res-destino").text(resp.analise.destino);
            $("#res-distancia").text(resp.analise.distancia);
            $("#res-tempo").text(resp.analise.tempo_estimado);
            $("#res-consumo").text(resp.analise.consumo_combustivel);
            $("#res-co2").text(resp.analise.emissao_co2);
            $("#res-pedagio").text(resp.analise.pedagio_estimado);
            let htmlTabela = "";
            for (let tipo in resp.custos) {
              htmlTabela += `<tr>
                <td>${tipo}</td>
                <td>R$ ${resp.custos[tipo].toLocaleString("pt-BR", {minimumFractionDigits: 2})}</td>
              </tr>`;
            }
            $("#tabela-resultado").html(htmlTabela);
            $("#resultados").show();
            if (resp.rota_pontos && resp.rota_pontos.length > 1) {
              // Chame a fun√ß√£o do mapa se necess√°rio
            } else {
              $("#map").hide();
            }
          },
          error: function (xhr) {
            $("#loading").hide();
            alert("Erro ao calcular rota: " + xhr.responseText);
          },
        });
      });

      // Fracionado Select2 Estados/Munic√≠pios
      $("#uf_origem_frac").select2({
        placeholder: "Selecione o estado",
        ajax: {
          url: "/estados_fracionado",
          dataType: "json",
          processResults: function (data) { return { results: data }; },
          cache: true,
        }
      });
      $("#uf_origem_frac").on("change", function () {
        let uf = $(this).val();
        $("#municipio_origem_frac").val(null).trigger("change").prop("disabled", !uf);
        if (uf) {
          $("#municipio_origem_frac").select2({
            placeholder: "Selecione o munic√≠pio",
            ajax: {
              url: "/municipios_fracionado/" + uf,
              dataType: "json",
              processResults: function (data) { return { results: data }; },
              cache: true,
            }
          });
        } else {
          $("#municipio_origem_frac").select2("destroy");
        }
      });
      $("#uf_destino_frac").select2({
        placeholder: "Selecione o estado",
        ajax: {
          url: "/estados_fracionado",
          dataType: "json",
          processResults: function (data) { return { results: data }; },
          cache: true,
        }
      });
      $("#uf_destino_frac").on("change", function () {
        let uf = $(this).val();
        $("#municipio_destino_frac").val(null).trigger("change").prop("disabled", !uf);
        if (uf) {
          $("#municipio_destino_frac").select2({
            placeholder: "Selecione o munic√≠pio",
            ajax: {
              url: "/municipios_destino_fracionado/" + uf,
              dataType: "json",
              processResults: function (data) { return { results: data }; },
              cache: true,
            }
          });
        } else {
          $("#municipio_destino_frac").select2("destroy");
        }
      });

      // Envio do formul√°rio fracionado
      $("#btn-fracionado").on("click", function () {
        const uf_origem = $("#uf_origem_frac").val();
        const origem = $("#municipio_origem_frac").val();
        const uf_destino = $("#uf_destino_frac").val();
        const destino = $("#municipio_destino_frac").val();
        const peso = $("#peso-frac").val();
        const cubagem = $("#cubagem-frac").val();
        if (!uf_origem || !origem || !uf_destino || !destino || !peso || !cubagem) {
          alert("Preencha todos os campos!");
          return;
        }
        $("#fracionado-resultado").html("<div class='loading'><div class='spinner'></div>Calculando...</div>");
        fetch('/calcular_fracionado', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({uf_origem, origem, uf_destino, destino, peso, cubagem})
        })
        .then(res => res.json())
        .then(data => {
          let html = '';
          if (data.principal) {
            html += `<h3>Melhor transportador: ${data.principal.agente} - R$ ${data.principal.valor.toFixed(2)}</h3>`;
          } else {
            html += `<h3>Nenhum frete encontrado para esse trecho.</h3>`;
          }
          if (data.todos && data.todos.length > 0) {
            html += `<table><thead><tr><th>Agente</th><th>Valor (R$)</th></tr></thead><tbody>`;
            data.todos.forEach(r => {
              html += `<tr><td>${r.agente}</td><td>${r.valor.toFixed(2)}</td></tr>`;
            });
            html += `</tbody></table>`;
          }
          $("#fracionado-resultado").html(html);
        }).catch(() => {
          $("#fracionado-resultado").html("<p>Erro ao calcular frete fracionado.</p>");
        });
      });
    });
  </script>
</body>
</html>
"""